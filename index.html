<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gestor Viking</title>
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="style.css">
    <script>
        window.onerror = function (msg, url, line) {
            alert("ERRO: " + msg + "\nLinha: " + line);
            return false;
        };
    </script>
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
</head>

<body>
    <!-- Login Modal (Overlay) -->
    <div id="login-modal" class="login-overlay">
        <div class="login-card">
            <h1 style="text-align:center; font-size:1.5rem; margin-bottom:20px;" id="login-title">Acessar Sistema</h1>

            <form id="login-form">
                <input type="checkbox" id="is-register" style="display:none;">
                <div class="input-group">
                    <label>Email</label>
                    <input type="email" id="email" placeholder="seu@email.com" required>
                </div>
                <div class="input-group">
                    <label>Senha</label>
                    <input type="password" id="password" placeholder="******" required minlength="6">
                </div>

                <p id="login-error" style="color:var(--danger); font-size:0.9rem; display:none; margin-bottom:10px;">
                </p>

                <button type="button" id="btn-login-submit" onclick="handleLogin()" class="btn-primary">ENTRAR</button>
            </form>

            <div style="margin-top:20px; text-align:center;">
                <button id="btn-toggle-mode" onclick="toggleAuthMode()" type="button"
                    style="background:none; border:none; color:var(--primary); font-weight:600; cursor:pointer;">
                    N√£o tem conta? Crie agora
                </button>
            </div>
        </div>
    </div>

    <!-- App Container -->
    <div id="app" class="container blurred">
        <!-- Header -->
        <header class="header">
            <div id="user-display">
                <!-- Auth JS will populate this -->
                <p style="font-size:0.8rem; color:var(--text-muted); font-weight:600;">Carregando...</p>
            </div>
            <button id="theme-toggle" class="icon-btn" aria-label="Alternar Tema">
                <!-- Moon Icon -->
                <svg id="moon-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                </svg>
            </button>
        </header>

        <!-- Main Form -->
        <main id="form-view" class="view active">
            <form id="entry-form">
                <!-- Data e Hora (Auto) -->
                <div class="row">
                    <div class="input-group">
                        <label>Data In√≠cio</label>
                        <input type="date" id="data_inicio" required>
                    </div>
                    <div class="input-group">
                        <label>Hora In√≠cio</label>
                        <input type="time" id="hora_inicio" required>
                    </div>
                </div>

                <!-- EDIT MODE FIELDS (Hidden by default) -->
                <div id="edit-fields"
                    style="display:none; background:var(--bg-card); border:1px solid var(--border); padding:12px; border-radius:12px; margin-bottom:16px;">
                    <p
                        style="font-size:0.8rem; font-weight:700; color:var(--primary); margin-bottom:12px; text-transform:uppercase;">
                        Dados de Finaliza√ß√£o</p>
                    <div class="row">
                        <div class="input-group">
                            <label>Data Fim</label>
                            <input type="date" id="data_fim">
                        </div>
                        <div class="input-group">
                            <label>Hora Fim</label>
                            <input type="time" id="hora_fim">
                        </div>
                    </div>
                    <div class="input-group" style="margin-top:12px;">
                        <label for="km_final">KM Final</label>
                        <input type="number" id="km_final" placeholder="KM do Od√¥metro">
                    </div>

                    <!-- Prediction Box -->
                    <div id="edit-preview"
                        style="margin-top:16px; padding:10px; background:var(--bg-main); border-radius:8px; text-align:center; display:none;">
                        <p style="font-size:0.8rem; color:var(--text-muted); margin-bottom:4px;">Valor Recalculado
                            (Estimativa)</p>
                        <p id="preview-val-text" style="font-size:1.2rem; font-weight:800; color:var(--success);">R$
                            0,00</p>
                    </div>
                </div>
                <!-- ID Hidden for Edit -->
                <input type="hidden" id="editing_job_id" value="">

                <!-- Empresa -->
                <div class="input-group">
                    <label>Empresa Solicitante</label>
                    <input type="text" id="empresa" list="empresas-list" placeholder="Selecione ou digite..."
                        autocomplete="off">
                    <datalist id="empresas-list">
                        <option value="OnSystem">
                        <option value="RVS">
                        <option value="C&C">
                        <option value="Sancor">
                        <option value="Carsystem">
                    </datalist>
                </div>

                <!-- Pagamento (Radio Cards) -->
                <div class="input-group">
                    <label>Status do Pagamento</label>
                    <div class="radio-cards">
                        <label class="radio-card">
                            <input type="radio" name="pagamento" value="PAGO">
                            <span>PAGO</span>
                        </label>
                        <label class="radio-card">
                            <input type="radio" name="pagamento" value="PRAZO">
                            <span>PRAZO</span>
                        </label>
                        <label class="radio-card">
                            <input type="radio" name="pagamento" value="N√ÉO PAGO" checked>
                            <span>N√ÉO PAGO</span>
                        </label>
                    </div>
                </div>
                <!-- Prazo de Pagamento (Condicional) -->
                <div class="input-group" id="div-prazo"
                    style="display:none; margin-top: -10px; margin-bottom: 12px; animation: fadeIn 0.3s ease;">
                    <label style="color:var(--warning);">Data Limite para Pagamento</label>
                    <input type="date" id="prazo_pagamento" style="border-color:var(--warning);">
                </div>

                <!-- Tipo (Select Chips) -->
                <div class="input-group">
                    <label>Tipo de Acionamento</label>
                    <div class="chips-container" id="tipo-chips">
                        <!-- JS vai popular isso -->
                    </div>
                    <input type="hidden" id="tipo_acionamento" value="ROUBO/FURTO">
                </div>

                <!-- Placa e Modelo -->
                <div class="row">
                    <div class="input-group">
                        <label>Placa</label>
                        <input type="text" id="placa" placeholder="ABC-1234" autocapitalize="characters" maxlength="8">
                    </div>
                    <div class="input-group">
                        <label>Modelo do Ve√≠culo</label>
                        <input type="text" id="modelo" placeholder="Ex: Gol Prata">
                    </div>
                </div>

                <!-- Custos e Obs (Opcional) -->
                <div class="input-group">
                    <details>
                        <summary
                            style="color:var(--primary); font-weight:600; cursor:pointer; padding:10px 0; font-size:0.9rem; display:flex; align-items:center; gap:8px;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <line x1="12" y1="5" x2="12" y2="19"></line>
                                <line x1="5" y1="12" x2="19" y2="12"></line>
                            </svg>
                            Adicionar Custos & Observa√ß√µes
                        </summary>
                        <div style="margin-top:16px; padding-left:4px;">
                            <div class="input-group">
                                <label>KM Inicial (Opcional)</label>
                                <input type="number" id="km_inicial" placeholder="Od√¥metro na Sa√≠da">
                            </div>
                            <div class="input-group">
                                <label>Custos Extras (Ped√°gio, etc)</label>
                                <div style="position:relative;">
                                    <span
                                        style="position:absolute; left:16px; top:14px; color:var(--text-muted);">R$</span>
                                    <input type="number" id="custos" step="0.01" style="padding-left:40px;"
                                        placeholder="0,00" value="">
                                </div>
                            </div>
                            <div class="input-group">
                                <label>Observa√ß√µes Detalhadas</label>
                                <textarea id="obs" rows="3"
                                    placeholder="Informa√ß√µes relevantes sobre o servi√ßo..."></textarea>
                            </div>
                        </div>
                    </details>
                </div>

                <!-- Bot√£o Gigante -->
                <button type="submit" id="btn-submit-job" class="btn-primary">
                    INICIAR SERVI√áO
                </button>
            </form>
        </main>

        <!-- Active Jobs View (Hidden by default) -->
        <div id="active-jobs-view" class="view" style="display:none;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2>Em Andamento</h2>
                <!-- Loader placeholder logic could go here -->
            </div>
            <div id="jobs-list">
                <!-- JS Populates this -->
                <div style="text-align:center; padding:40px; color:var(--text-muted);">
                    Carregando servi√ßos...
                </div>
            </div>
            <button id="btn-back-home" class="btn-secondary">Voltar para In√≠cio</button>
        </div>

        <!-- History View -->
        <div id="history-view" class="view" style="display:none;">
            <h2>Hist√≥rico Finalizado</h2>
            <div id="history-list">
                <!-- JS Populates this -->
            </div>
        </div>

        <!-- Settings View -->
        <div id="settings-view" class="view" style="display:none;">
            <h2>Configura√ß√µes</h2>
            <div class="settings-container" style="padding:16px;">
                <h3 style="margin-bottom:8px; color:var(--primary);">Tabela de Pre√ßos</h3>

                <!-- PWA Install Button (Hidden by default) -->
                <button id="btn-install-app" class="btn-primary"
                    style="display:none; margin-bottom:16px; background:var(--primary);">
                    üì≤ Instalar App na √Årea de Trabalho
                </button>

                <p class="text-muted" style="font-size:0.9rem; margin-bottom:16px;">Defina os valores padr√£o (R$) por
                    empresa e tipo de servi√ßo.</p>

                <button class="btn-secondary" onclick="window.promptAddCompany()"
                    style="margin-bottom:16px; width:100%; border-color:var(--primary); color:var(--primary);">
                    + Adicionar Nova Empresa
                </button>

                <div id="pricing-forms">
                    <!-- JS populate -->
                    <div style="text-align:center; padding:20px;">Carregando configura√ß√µes...</div>
                </div>

                <div style="margin-top: 20px; padding-bottom:80px;">
                    <button id="btn-save-settings" class="btn-primary" onclick="window.saveSettings()"
                        style="background:var(--success);">
                        üíæ SALVAR CONFIGURA√á√ïES
                    </button>
                    <p id="settings-status" style="text-align:center; margin-top:8px; font-size:0.8rem; height:20px;">
                    </p>

                    <hr style="margin: 20px 0; border:0; border-top:1px solid var(--border);">

                    <h3 style="margin-bottom:8px; font-size:1rem; color:var(--primary);">Apoie o Projeto ‚òï</h3>
                    <p class="text-muted" style="font-size:0.9rem; margin-bottom:12px;">Gostou do app? Ajude a mant√™-lo
                        no ar com uma doa√ß√£o via PIX.</p>

                    <div
                        style="background:var(--card-bg); border:1px solid var(--border); padding:12px; border-radius:8px; display:flex; gap:8px; align-items:center;">
                        <input type="text" value="40eb4d89-1962-4bdb-b04b-d46af9ac21ec" id="pix-key" readonly
                            style="flex:1; background:transparent; border:none; color:var(--text-color); font-family:monospace; font-size:0.9rem;">
                        <button class="btn-primary" onclick="window.copyPix()"
                            style="width:auto; padding:6px 12px; font-size:0.8rem;">
                            COPIAR
                        </button>
                    </div>

                    <hr style="margin: 20px 0; border:0; border-top:1px solid var(--border);">

                    <h3 style="margin-bottom:8px; font-size:1rem; color:var(--text-muted);">Suporte & Sugest√µes</h3>
                    <a href="https://wa.me/5511959629722?text=Ol√°,%20tenho%20uma%20sugest√£o%20para%20o%20Gestor%20Viking!"
                        target="_blank" class="btn-secondary"
                        style="display:block; text-align:center; text-decoration:none; color:var(--success); border-color:var(--success);">
                        üí¨ Falar no WhatsApp
                    </a>
                </div>
            </div>
        </div>

        <!-- Navigation Bar -->
        <nav class="bottom-nav">
            <button class="nav-item active" data-target="form-view">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 5v14M5 12h14" />
                </svg>
                <span>Novo</span>
            </button>
            <button class="nav-item" data-target="active-jobs-view">
                <div style="position:relative;">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                        <line x1="16" y1="13" x2="8" y2="13"></line>
                        <line x1="16" y1="17" x2="8" y2="17"></line>
                        <polyline points="10 9 9 9 8 9"></polyline>
                    </svg>
                    <span id="badge-count" class="badge" style="display:none;">0</span>
                </div>
                <span>Ativos</span>
            </button>
            <button class="nav-item" data-target="history-view">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
                <span>Hist√≥rico</span>
            </button>
            <button class="nav-item" data-target="settings-view">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="3"></circle>
                    <path
                        d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z">
                    </path>
                </svg>
                <span>Ajustes</span>
            </button>
        </nav>
    </div>

    <!-- Firebase SDKs (Modular) -->
    <!-- We will use ES Modules in app.js, so no need for script tags here if we use type="module" -->
    <!-- But to keep it simple without a bundler, we can use the Compat libraries or just Import Maps. -->

    <!-- UI Logic (Non-Module) for Immediate Availability -->
    <script>
        window.toggleAuthMode = function () {
            const isRegInput = document.getElementById('is-register');
            const btn = document.getElementById('btn-toggle-mode');
            const submitBtn = document.getElementById('btn-login-submit');
            const title = document.getElementById('login-title');

            isRegInput.checked = !isRegInput.checked;

            if (isRegInput.checked) {
                title.textContent = "Criar Nova Conta";
                submitBtn.textContent = "CRIAR CONTA";
                btn.textContent = "J√° tem conta? Clique aqui";
                submitBtn.style.background = "var(--success)";
            } else {
                title.textContent = "Acessar Sistema";
                submitBtn.textContent = "ENTRAR";
                btn.textContent = "N√£o tem conta? Crie agora";
                submitBtn.style.background = "";
            }
        };

        // Stub to prevent ReferenceError before module loads
        window.handleLogin = function () {
            alert("O sistema ainda est√° carregando... Aguarde um instante e tente novamente.");
        }
    </script>

    <!-- Firebase Compat SDKs (Required for file:// execution) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <!-- Config (Runs immediately) -->
    <script src="firebase-config.js"></script>

    <!-- Auth Logic (Globals) -->
    <script>
        // Override stub
        window.handleLogin = async function () {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const isRegister = document.getElementById('is-register').checked;
            const errorMsg = document.getElementById('login-error');
            const btn = document.getElementById('btn-login-submit');

            if (!email || !password) {
                alert("Por favor, preencha email e senha.");
                return;
            }

            errorMsg.style.display = 'none';
            btn.disabled = true;
            const originalText = btn.textContent;
            btn.textContent = "Processando...";

            try {
                if (isRegister) {
                    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                    await userCredential.user.updateProfile({
                        displayName: email.split('@')[0]
                    });
                    alert("Conta criada com sucesso!");
                    window.location.reload();
                } else {
                    await auth.signInWithEmailAndPassword(email, password);
                }
            } catch (error) {
                console.error(error);
                let msg = "Erro desconhecido.";
                if (error.code === 'auth/wrong-password') msg = "Senha incorreta.";
                else if (error.code === 'auth/user-not-found') msg = "Email n√£o cadastrado.";
                else if (error.code === 'auth/email-already-in-use') msg = "Email j√° existe.";
                else if (error.code === 'auth/weak-password') msg = "Senha fraca (min 6 caracteres).";
                else if (error.code === 'auth/invalid-email') msg = "Email inv√°lido.";

                errorMsg.textContent = msg;
                errorMsg.style.display = 'block';
                btn.disabled = false;
                btn.textContent = originalText;
            }
        };
    </script>

    <!-- App Logic (Globals) -->
    <script src="app.js?v=12"></script>

    <!-- Service Worker -->
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js');
        }
    </script>
</body>

</html>